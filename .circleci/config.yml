version: 2
# We're doing a workspace persistence based on the root of the FS which looks completely wrong.
# It's because we cannot rely solely on virtualenv as the sole libraries source. Protobuf
# (which is a current python dependency) installs some files directly in the system.
jobs:
  prepare:
    docker:
      - image: circleci/python:3.6
    parallelism: 2
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local
      - restore_cache:
          keys:
            - v3-dependencies-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - v3-dependencies-{{ .Branch }}-
            - v3-dependencies-
      - run: .circleci/prepare.sh
      - save_cache:
          paths:
            - /usr/local/lib/python3.6/site-packages
            - /usr/local/bin
          key: v3-dependencies-{{ .Branch }}-{{ checksum "requirements.txt" }}
      - persist_to_workspace:
          root: /
          paths:
            - home/circleci
            - usr/local/lib/python3.6/site-packages
            - usr/local/bin

  get-build-infos:
    docker:
      - image: habx/devops-build-infos
    steps:
      - checkout
      - run: build/run.sh
      - persist_to_workspace:
          - home/circleci/version.txt
          - home/circleci/package.json
          - home/circleci/build.json

  tests:
    docker:
      - image: circleci/python:3.6
    parallelism: 4
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local
      - attach_workspace:
          at: /
      - run: ./run_tests.sh

  build-container:
    docker:
      - image: plugins/ecr:17.05
    steps:
      - attach_workspace:
          at: /root
      - setup_remote_docker:
          docker_layer_caching: true
      - run: .circleci/build-container.sh

  deploy-to-kubernetes-standard-worker:
    docker:
      - image: quay.io/honestbee/drone-kubernetes
    steps:
      - run:
          command: |
            export CIRCLE_PROJECT_REPONAME=worker-optimizer-v2
            export BUILD_REF=$(if [ -z "$CIRCLE_TAG" ]; then echo ${CIRCLE_BRANCH/\//-}-${CIRCLE_SHA1:0:7}; else echo $CIRCLE_TAG; fi)
            export DST_NAMESPACE=$(if [ -z "$CIRCLE_TAG" ]; then echo dev; else echo staging; fi)

            export PLUGIN_TAG=${BUILD_REF}
            export PLUGIN_REPO=724009402066.dkr.ecr.eu-west-1.amazonaws.com/${CIRCLE_PROJECT_REPONAME}
            export PLUGIN_CONTAINER=${CIRCLE_PROJECT_REPONAME}
            export PLUGIN_DEPLOYMENT=${CIRCLE_PROJECT_REPONAME}
            export PLUGIN_NAMESPACE=${DST_NAMESPACE}
            export PLUGIN_KUBERNETES_SERVER=${KUBERNETES_SERVER_DEV}
            export PLUGIN_KUBERNETES_TOKEN=${KUBERNETES_TOKEN_DEV}
            /bin/update.sh

  deploy-to-kubernetes-low-priority-worker:
    docker:
      - image: quay.io/honestbee/drone-kubernetes
    steps:
      - run:
          command: |
            export CIRCLE_PROJECT_REPONAME=worker-optimizer-v2
            export BUILD_REF=$(if [ -z "$CIRCLE_TAG" ]; then echo ${CIRCLE_BRANCH/\//-}-${CIRCLE_SHA1:0:7}; else echo $CIRCLE_TAG; fi)
            export DST_NAMESPACE=$(if [ -z "$CIRCLE_TAG" ]; then echo dev; else echo staging; fi)

            export PLUGIN_TAG=${BUILD_REF}
            export PLUGIN_REPO=724009402066.dkr.ecr.eu-west-1.amazonaws.com/${CIRCLE_PROJECT_REPONAME}
            export PLUGIN_CONTAINER=${CIRCLE_PROJECT_REPONAME}-low-priority
            export PLUGIN_DEPLOYMENT=${CIRCLE_PROJECT_REPONAME}-low-priority
            export PLUGIN_NAMESPACE=${DST_NAMESPACE}
            export PLUGIN_KUBERNETES_SERVER=${KUBERNETES_SERVER_DEV}
            export PLUGIN_KUBERNETES_TOKEN=${KUBERNETES_TOKEN_DEV}
            /bin/update.sh

workflows:
  version: 2
  ci-process:
    jobs:
      - prepare
      - tests:
          requires:
            - prepare
          filters:
            tags:
              only: /^v.*/

      - build-container:
          context: default_env_vars
          requires:
            - prepare
            - get-build-infos
      #          filters:
      #            tags:
      #              only: /^v.*/
      #            branches:
      #              only:
      #                - dev

      - deploy-to-kubernetes-standard-worker:
          context: default_env_vars
          requires:
            - build-container
            - tests
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - dev

      - deploy-to-kubernetes-low-priority-worker:
          context: default_env_vars
          requires:
            - build-container
            - tests
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - dev
